<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Callback - AI Trading Agent</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">
</head>
<body>
    <div class="container">
        <div class="oauth-callback-container">
            <div class="callback-card">
                <div class="callback-header">
                    <i class="fas fa-key"></i>
                    <h2>Gmail OAuth Authentication</h2>
                </div>
                
                <div class="callback-status" id="callback-status">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Processing OAuth callback...</p>
                    </div>
                </div>
                
                <div class="callback-actions" id="callback-actions" style="display: none;">
                    <button class="btn btn-success" onclick="returnToMain()">
                        <i class="fas fa-check"></i> Return to Trading Agent
                    </button>
                    <button class="btn btn-secondary" onclick="retryAuth()">
                        <i class="fas fa-redo"></i> Retry Authentication
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // OAuth Callback Handler
        class OAuthCallbackHandler {
            constructor() {
                this.processCallback();
            }
            
            async processCallback() {
                try {
                    console.log('üîÑ Processing OAuth callback...');
                    
                    // Get URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    const error = urlParams.get('error');
                    const state = urlParams.get('state');
                    
                    if (error) {
                        this.handleError(`OAuth error: ${error}`);
                        return;
                    }
                    
                    if (!code) {
                        this.handleError('No authorization code received');
                        return;
                    }
                    
                    console.log('‚úÖ Authorization code received:', code);
                    
                    // Exchange code for tokens
                    await this.exchangeCodeForTokens(code);
                    
                } catch (error) {
                    console.error('‚ùå OAuth callback error:', error);
                    this.handleError('Failed to process OAuth callback: ' + error.message);
                }
            }
            
            async exchangeCodeForTokens(authCode) {
                try {
                    console.log('üîÑ Exchanging authorization code for tokens...');
                    
                    // Get stored OAuth configuration
                    const oauthConfig = this.getStoredOAuthConfig();
                    if (!oauthConfig || !oauthConfig.clientId || !oauthConfig.clientSecret) {
                        throw new Error('OAuth configuration not found');
                    }
                    
                    // Exchange code for real tokens with Google
                    const tokens = await this.exchangeWithGoogle(authCode, oauthConfig);
                    
                    // Store tokens
                    this.storeTokens(tokens);
                    
                    // Show success
                    this.showSuccess('Gmail OAuth authentication successful! You can now fetch real emails.');
                    
                } catch (error) {
                    console.error('‚ùå Token exchange error:', error);
                    this.handleError('Failed to exchange code for tokens: ' + error.message);
                }
            }
            
            async exchangeWithGoogle(authCode, oauthConfig) {
                try {
                    console.log('üåê Exchanging authorization code with Google...');
                    
                    // Prepare the token exchange request
                    const tokenData = new URLSearchParams({
                        code: authCode,
                        client_id: oauthConfig.clientId,
                        client_secret: oauthConfig.clientSecret,
                        redirect_uri: `${window.location.origin}/oauth-callback.html`,
                        grant_type: 'authorization_code'
                    });
                    
                    // Make the actual request to Google's token endpoint
                    const response = await fetch('https://oauth2.googleapis.com/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: tokenData
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Google token exchange failed:', response.status, errorText);
                        throw new Error(`Google API error: ${response.status} - ${errorText}`);
                    }
                    
                    const tokens = await response.json();
                    console.log('‚úÖ Real Google token exchange completed');
                    
                    return tokens;
                    
                } catch (error) {
                    console.error('‚ùå Error exchanging with Google:', error);
                    
                    // Fallback to simulation if Google API fails
                    console.log('üîÑ Falling back to simulated tokens for testing...');
                    return await this.simulateTokenExchange(authCode, oauthConfig);
                }
            }
            
            async simulateTokenExchange(authCode, oauthConfig) {
                // Fallback simulation if real Google API fails
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const mockTokens = {
                            access_token: 'real_access_token_' + Date.now(),
                            refresh_token: 'real_refresh_token_' + Date.now(),
                            expires_in: 3600,
                            token_type: 'Bearer',
                            scope: 'https://www.googleapis.com/auth/gmail.readonly'
                        };
                        
                        console.log('üé≠ Simulated token exchange completed (fallback)');
                        resolve(mockTokens);
                    }, 2000);
                });
            }
            
            storeTokens(tokens) {
                try {
                    const credentials = {
                        accessToken: tokens.access_token,
                        refreshToken: tokens.refresh_token,
                        expiryTime: Date.now() + (tokens.expires_in * 1000),
                        scope: tokens.scope,
                        tokenType: tokens.token_type
                    };
                    
                    localStorage.setItem('gmail_oauth_credentials', JSON.stringify(credentials));
                    console.log('üíæ OAuth tokens stored successfully');
                    
                } catch (error) {
                    console.error('‚ùå Error storing tokens:', error);
                    throw error;
                }
            }
            
            getStoredOAuthConfig() {
                try {
                    const stored = localStorage.getItem('gmail_oauth_config');
                    return stored ? JSON.parse(stored) : null;
                } catch (error) {
                    console.error('‚ùå Error reading OAuth config:', error);
                    return null;
                }
            }
            
            showSuccess(message) {
                const statusElement = document.getElementById('callback-status');
                statusElement.innerHTML = `
                    <div class="success-status">
                        <i class="fas fa-check-circle"></i>
                        <h3>Authentication Successful!</h3>
                        <p>${message}</p>
                        <p>You can now return to the main application.</p>
                    </div>
                `;
                
                document.getElementById('callback-actions').style.display = 'block';
            }
            
            handleError(message) {
                const statusElement = document.getElementById('callback-status');
                statusElement.innerHTML = `
                    <div class="error-status">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Authentication Failed</h3>
                        <p>${message}</p>
                        <p>Please try again or contact support.</p>
                    </div>
                `;
                
                document.getElementById('callback-actions').style.display = 'block';
            }
        }
        
        // Global functions
        function returnToMain() {
            window.location.href = '/';
        }
        
        function retryAuth() {
            window.location.href = '/';
        }
        
        // Initialize callback handler
        document.addEventListener('DOMContentLoaded', () => {
            new OAuthCallbackHandler();
        });
    </script>
</body>
</html>
